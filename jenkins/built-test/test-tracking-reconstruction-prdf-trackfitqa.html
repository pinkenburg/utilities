<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>sPHENIX QA Overlay with Legend</title>
  <script src="https://root.cern/js/latest/scripts/JSRoot.core.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 20px; }
    h2 { margin-bottom: 15px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
      gap: 20px;
    }
    .plot {
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
      padding: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .plot h3 {
      font-size: 1em;
      margin: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>sPHENIX Track Fitting QA</h2>
  <h3> <p style="color: red;">red markers == new</p>black histogram== reference
  <div id="plots" class="grid"></div>

  
  <script>
    const params = new URLSearchParams(window.location.search);
    const refFile = params.get("refFile");
    const newFile = params.get("newFile");
    const histograms = [
      "h_TrackFittingQA_eta_negatively_charged_tracks",
      "h_TrackFittingQA_eta_positively_charged_tracks",
      "h_TrackFittingQA_intt_states_negatively_charged_tracks",
      "h_TrackFittingQA_intt_states_positively_charged_tracks",
      "h_TrackFittingQA_mvtx_states_negatively_charged_tracks",
      "h_TrackFittingQA_mvtx_states_positively_charged_tracks",
      "h_TrackFittingQA_p_negatively_charged_tracks",
      "h_TrackFittingQA_p_positively_charged_tracks",
      "h_TrackFittingQA_pt_negatively_charged_tracks",
      "h_TrackFittingQA_pt_positively_charged_tracks",
      "h_TrackFittingQA_quality_negatively_charged_tracks",
      "h_TrackFittingQA_quality_positively_charged_tracks",
      "h_TrackFittingQA_tpc_states_negatively_charged_tracks",
      "h_TrackFittingQA_tpc_states_positively_charged_tracks",
      "h_TrackFittingQA_tpot_states_negatively_charged_tracks",
      "h_TrackFittingQA_tpot_states_positively_charged_tracks"
    ];

    function makeTitle(name) {
      return name
        .replace("h_TrackFittingQA_", "")
        .replace(/_/g, " ")
        .replace(/\b\w/g, l => l.toUpperCase());
    }

    Promise.all([
      JSROOT.openFile(refFile),
      JSROOT.openFile(newFile)
    ]).then(([file1, file2]) => {
      const container = document.getElementById("plots");

      histograms.forEach((hname, idx) => {
        const div = document.createElement("div");
        div.className = "plot";
	  div.innerHTML = `<h3>${makeTitle(hname)}</h3>
                 <div id="plot_${idx}" style="width:100%; height:350px"></div>
                 <div id="pvalue_${idx}" style="text-align:center; margin-top:5px;">
                   p-value: calculating...
                 </div>`;

        container.appendChild(div);

        // Read both histograms
          Promise.all([file1.readObject(hname), file2.readObject(hname)]).then(([h_ref, h_new]) => {
	      
	      const nbins = h_ref.fXaxis.fNbins;
	      const refbins = h_ref.fArray;
	      const newbins = h_new.fArray;
	      let chi2 = 0;
	      let dof = 0;
	      
	      for (let i =1; i<= nbins; i++)
	      {
		  const O = refbins[i];
		  const E = newbins[i];
		  if(E>0){
		      chi2 += (O - E) ** 2 / E;
		      dof += 1;
		  }
	      }
	      
	      dof -= 1;
	      
	      const p_value = 1 - jStat.chisquare.cdf(chi2, dof);

              // Draw first histogram
	      h_ref.fLineColor=1;
	      h_ref.fStatStyle=0;
	      h_ref.fXaxis.fTitleSize = 0.05;
	      h_ref.fYaxis.fTitleSize = 0.05;
	      h_ref.fXaxis.fLabelSize = 0.045;
	      h_ref.fYaxis.fLabelSize = 0.045;
	      h_ref.fXaxis.fTitleOffset = 0.8;
	      h_ref.fYaxis.fTitleOffset = 0.8;
	      h_ref.fTitle = "";
          JSROOT.draw(`plot_${idx}`, h_ref, "hist nostat tickx2 ticky2").then(painter => {
              // Overlay second histogram
	      h_new.fMarkerStyle=20;
	      h_new.fMarkerSize=1.;
	      h_new.fMarkerColor=2;
	      h_new.fStatStyle=0;
	      h_new.fLineColor=2;
	      
              JSROOT.draw(`plot_${idx}`, h_new, "EPSAME").then(() => {
            	   
            });
          });
	      	  const pDiv = document.getElementById(`pvalue_${idx}`);
pDiv.innerHTML = `p-value = ${p_value}`;
          });


      });
    });
  </script>
</body>
</html>
